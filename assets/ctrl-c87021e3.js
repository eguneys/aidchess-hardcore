var ao=Object.defineProperty;var uo=(e,o,n)=>o in e?ao(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n;var v=(e,o,n)=>(uo(e,typeof o!="symbol"?o+"":o,n),n);import{a as fo,h as ke,o as ye,j as po,t as ho}from"./index-8dd89830.js";import{c as mo}from"./store-00e80bbf.js";const go=["white","black"],ae=["a","b","c","d","e","f","g","h"],de=["1","2","3","4","5","6","7","8"],vo=[...de].reverse(),ue=Array.prototype.concat(...ae.map(e=>de.map(o=>e+o))),y=e=>ue[8*e[0]+e[1]],m=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],$e=ue.map(m);function wo(e){let o;const n=()=>(o===void 0&&(o=e()),o);return n.clear=()=>{o=void 0},n}const bo=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const o=performance.now()-e;return e=void 0,o}}},fe=e=>e==="white"?"black":"white",Z=(e,o)=>{const n=e[0]-o[0],r=e[1]-o[1];return n*n+r*r},se=(e,o)=>e.role===o.role&&e.color===o.color,G=e=>(o,n)=>[(n?o[0]:7-o[0])*e.width/8,(n?7-o[1]:o[1])*e.height/8],D=(e,o)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px)`},Ke=(e,o,n=1)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${n})`},pe=(e,o)=>{e.style.visibility=o?"visible":"hidden"},B=e=>{var o;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((o=e.targetTouches)===null||o===void 0)&&o[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Ne=e=>e.buttons===2||e.button===2,O=(e,o)=>{const n=document.createElement(e);return o&&(n.className=o),n};function Te(e,o,n){const r=m(e);return o||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const H=(e,o)=>Math.abs(e-o),ko=e=>(o,n,r,t)=>H(o,r)<2&&(e==="white"?t===n+1||n<=1&&t===n+2&&o===r:t===n-1||n>=6&&t===n-2&&o===r),Re=(e,o,n,r)=>{const t=H(e,n),i=H(o,r);return t===1&&i===2||t===2&&i===1},He=(e,o,n,r)=>H(e,n)===H(o,r),Be=(e,o,n,r)=>e===n||o===r,We=(e,o,n,r)=>He(e,o,n,r)||Be(e,o,n,r),yo=(e,o,n)=>(r,t,i,s)=>H(r,i)<2&&H(t,s)<2||n&&t===s&&t===(e==="white"?0:7)&&(r===4&&(i===2&&o.includes(0)||i===6&&o.includes(7))||o.includes(i));function Po(e,o){const n=o==="white"?"1":"8",r=[];for(const[t,i]of e)t[1]===n&&i.color===o&&i.role==="rook"&&r.push(m(t)[0]);return r}function Le(e,o,n){const r=e.get(o);if(!r)return[];const t=m(o),i=r.role,s=i==="pawn"?ko(r.color):i==="knight"?Re:i==="bishop"?He:i==="rook"?Be:i==="queen"?We:yo(r.color,Po(e,r.color),n);return $e.filter(c=>(t[0]!==c[0]||t[1]!==c[1])&&s(t[0],t[1],c[0],c[1])).map(y)}function b(e,...o){e&&setTimeout(()=>e(...o),1)}function So(e){e.orientation=fe(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Mo(e,o){for(const[n,r]of o)r?e.pieces.set(n,r):e.pieces.delete(n)}function Co(e,o){if(e.check=void 0,o===!0&&(o=e.turnColor),o)for(const[n,r]of e.pieces)r.role==="king"&&r.color===o&&(e.check=n)}function xo(e,o,n,r){T(e),e.premovable.current=[o,n],b(e.premovable.events.set,o,n,r)}function N(e){e.premovable.current&&(e.premovable.current=void 0,b(e.premovable.events.unset))}function qo(e,o,n){N(e),e.predroppable.current={role:o,key:n},b(e.predroppable.events.set,o,n)}function T(e){const o=e.predroppable;o.current&&(o.current=void 0,b(o.events.unset))}function Do(e,o,n){if(!e.autoCastle)return!1;const r=e.pieces.get(o);if(!r||r.role!=="king")return!1;const t=m(o),i=m(n);if(t[1]!==0&&t[1]!==7||t[1]!==i[1])return!1;t[0]===4&&!e.pieces.has(n)&&(i[0]===6?n=y([7,i[1]]):i[0]===2&&(n=y([0,i[1]])));const s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(o),e.pieces.delete(n),t[0]<i[0]?(e.pieces.set(y([6,i[1]]),r),e.pieces.set(y([5,i[1]]),s)):(e.pieces.set(y([2,i[1]]),r),e.pieces.set(y([3,i[1]]),s)),!0)}function Ie(e,o,n){const r=e.pieces.get(o),t=e.pieces.get(n);if(o===n||!r)return!1;const i=t&&t.color!==r.color?t:void 0;return n===e.selected&&P(e),b(e.events.move,o,n,i),Do(e,o,n)||(e.pieces.set(n,r),e.pieces.delete(o)),e.lastMove=[o,n],e.check=void 0,b(e.events.change),i||!0}function he(e,o,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return b(e.events.dropNewPiece,o,n),e.pieces.set(n,o),e.lastMove=[n],e.check=void 0,b(e.events.change),e.movable.dests=void 0,e.turnColor=fe(e.turnColor),!0}function _e(e,o,n){const r=Ie(e,o,n);return r&&(e.movable.dests=void 0,e.turnColor=fe(e.turnColor),e.animation.current=void 0),r}function je(e,o,n){if(me(e,o,n)){const r=_e(e,o,n);if(r){const t=e.hold.stop();P(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:t};return r!==!0&&(i.captured=r),b(e.movable.events.after,o,n,i),!0}}else if(Oo(e,o,n))return xo(e,o,n,{ctrlKey:e.stats.ctrlKey}),P(e),!0;return P(e),!1}function Fe(e,o,n,r){const t=e.pieces.get(o);t&&(Ao(e,o,n)||r)?(e.pieces.delete(o),he(e,t,n,r),b(e.movable.events.afterNewPiece,t.role,n,{premove:!1,predrop:!1})):t&&zo(e,o,n)?qo(e,t.role,n):(N(e),T(e)),e.pieces.delete(o),P(e)}function ce(e,o,n){if(b(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled){P(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==o&&je(e,e.selected,o)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Ue(e,o)||ge(e,o))&&(Ve(e,o),e.hold.start())}function Ve(e,o){e.selected=o,ge(e,o)?e.premovable.dests=Le(e.pieces,o,e.premovable.castle):e.premovable.dests=void 0}function P(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Ue(e,o){const n=e.pieces.get(o);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const me=(e,o,n)=>{var r,t;return o!==n&&Ue(e,o)&&(e.movable.free||!!(!((t=(r=e.movable.dests)===null||r===void 0?void 0:r.get(o))===null||t===void 0)&&t.includes(n)))};function Ao(e,o,n){const r=e.pieces.get(o);return!!r&&(o===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function ge(e,o){const n=e.pieces.get(o);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}const Oo=(e,o,n)=>o!==n&&ge(e,o)&&Le(e.pieces,o,e.premovable.castle).includes(n);function zo(e,o,n){const r=e.pieces.get(o),t=e.pieces.get(n);return!!r&&(!t||t.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function Eo(e,o){const n=e.pieces.get(o);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function $o(e){const o=e.premovable.current;if(!o)return!1;const n=o[0],r=o[1];let t=!1;if(me(e,n,r)){const i=_e(e,n,r);if(i){const s={premove:!0};i!==!0&&(s.captured=i),b(e.movable.events.after,n,r,s),t=!0}}return N(e),t}function Ko(e,o){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(o(n)){const t={role:n.role,color:e.movable.color};he(e,t,n.key)&&(b(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return T(e),r}function ve(e){N(e),T(e),P(e)}function Pe(e){e.movable.color=e.movable.dests=e.animation.current=void 0,ve(e)}function W(e,o,n){let r=Math.floor(8*(e[0]-n.left)/n.width);o||(r=7-r);let t=7-Math.floor(8*(e[1]-n.top)/n.height);return o||(t=7-t),r>=0&&r<8&&t>=0&&t<8?y([r,t]):void 0}function No(e,o,n,r){const t=m(e),i=$e.filter(l=>We(t[0],t[1],l[0],l[1])||Re(t[0],t[1],l[0],l[1])),c=i.map(l=>Te(y(l),n,r)).map(l=>Z(o,l)),[,a]=c.reduce((l,p,d)=>l[0]<p?l:[p,d],[c[0],0]);return y(i[a])}const k=e=>e.orientation==="white",Ze="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",To={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Ro={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Ge(e){e==="start"&&(e=Ze);const o=new Map;let n=7,r=0;for(const t of e)switch(t){case" ":case"[":return o;case"/":if(--n,n<0)return o;r=0;break;case"~":{const i=o.get(y([r-1,n]));i&&(i.promoted=!0);break}default:{const i=t.charCodeAt(0);if(i<57)r+=i-48;else{const s=t.toLowerCase();o.set(y([r,n]),{role:To[s],color:t===s?"black":"white"}),++r}}}return o}function Ho(e){return vo.map(o=>ae.map(n=>{const r=e.get(n+o);if(r){let t=Ro[r.role];return r.color==="white"&&(t=t.toUpperCase()),r.promoted&&(t+="~"),t}else return"1"}).join("")).join("/").replace(/1{2,}/g,o=>o.length.toString())}function Xe(e,o){o.animation&&(we(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Ye(e,o){var n,r,t;if(!((n=o.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=o.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),we(e,o),o.fen&&(e.pieces=Ge(o.fen),e.drawable.shapes=((t=o.drawable)===null||t===void 0?void 0:t.shapes)||[]),"check"in o&&Co(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&Ve(e,e.selected),Xe(e,o),!e.movable.rookCastle&&e.movable.dests){const i=e.movable.color==="white"?"1":"8",s="e"+i,c=e.movable.dests.get(s),a=e.pieces.get(s);if(!c||!a||a.role!=="king")return;e.movable.dests.set(s,c.filter(l=>!(l==="a"+i&&c.includes("c"+i))&&!(l==="h"+i&&c.includes("g"+i))))}}function we(e,o){for(const n in o)Object.prototype.hasOwnProperty.call(o,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&Se(e[n])&&Se(o[n])?we(e[n],o[n]):e[n]=o[n])}function Se(e){if(typeof e!="object"||e===null)return!1;const o=Object.getPrototypeOf(e);return o===Object.prototype||o===null}const R=(e,o)=>o.animation.enabled?Lo(e,o):E(e,o);function E(e,o){const n=e(o);return o.dom.redraw(),n}const re=(e,o)=>({key:e,pos:m(e),piece:o}),Bo=(e,o)=>o.sort((n,r)=>Z(e.pos,n.pos)-Z(e.pos,r.pos))[0];function Wo(e,o){const n=new Map,r=[],t=new Map,i=[],s=[],c=new Map;let a,l,p;for(const[d,w]of e)c.set(d,re(d,w));for(const d of ue)a=o.pieces.get(d),l=c.get(d),a?l?se(a,l.piece)||(i.push(l),s.push(re(d,a))):s.push(re(d,a)):l&&i.push(l);for(const d of s)l=Bo(d,i.filter(w=>se(d.piece,w.piece))),l&&(p=[l.pos[0]-d.pos[0],l.pos[1]-d.pos[1]],n.set(d.key,p.concat(p)),r.push(l.key));for(const d of i)r.includes(d.key)||t.set(d.key,d.piece);return{anims:n,fadings:t}}function Qe(e,o){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(o-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=Io(r);for(const i of n.plan.anims.values())i[2]=i[0]*t,i[3]=i[1]*t;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>Qe(e,i))}}function Lo(e,o){const n=new Map(o.pieces),r=e(o),t=Wo(n,o);if(t.anims.size||t.fadings.size){const i=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:t},i||Qe(o,performance.now())}else o.dom.redraw();return r}const Io=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,_o=["green","red","blue","yellow"];function jo(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?P(e):ve(e);const n=B(o),r=W(n,k(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Zo(o),snapToValidMove:e.drawable.defaultSnapToValidMove},Je(e))}function Je(e){requestAnimationFrame(()=>{const o=e.drawable.current;if(o){const n=W(o.pos,k(e),e.dom.bounds());n||(o.snapToValidMove=!1);const r=o.snapToValidMove?No(o.orig,o.pos,k(e),e.dom.bounds()):n;r!==o.mouseSq&&(o.mouseSq=r,o.dest=r!==o.orig?r:void 0,e.dom.redrawNow()),Je(e)}})}function Fo(e,o){e.drawable.current&&(e.drawable.current.pos=B(o))}function Vo(e){const o=e.drawable.current;o&&(o.mouseSq&&Go(e.drawable,o),eo(e))}function eo(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Uo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),oo(e.drawable))}function Zo(e){var o;const n=(e.shiftKey||e.ctrlKey)&&Ne(e),r=e.altKey||e.metaKey||((o=e.getModifierState)===null||o===void 0?void 0:o.call(e,"AltGraph"));return _o[(n?1:0)+(r?2:0)]}function Go(e,o){const n=t=>t.orig===o.orig&&t.dest===o.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(t=>!n(t))),(!r||r.brush!==o.brush)&&e.shapes.push({orig:o.orig,dest:o.dest,brush:o.brush}),oo(e)}function oo(e){e.onChange&&e.onChange(e.shapes)}function Xo(e,o){if(!o.isTrusted||o.button!==void 0&&o.button!==0||o.touches&&o.touches.length>1)return;const n=e.dom.bounds(),r=B(o),t=W(r,k(e),n);if(!t)return;const i=e.pieces.get(t),s=e.selected;!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&Uo(e),o.cancelable!==!1&&(!o.touches||e.blockTouchScroll||i||s||Yo(e,r))&&o.preventDefault();const c=!!e.premovable.current,a=!!e.predroppable.current;e.stats.ctrlKey=o.ctrlKey,e.selected&&me(e,e.selected,t)?R(d=>ce(d,t),e):ce(e,t);const l=e.selected===t,p=ro(e,t);if(i&&p&&l&&Eo(e,t)){e.draggable.current={orig:t,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:o.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const d=e.dom.elements.ghost;d&&(d.className=`ghost ${i.color} ${i.role}`,D(d,G(n)(m(t),k(e))),pe(d,!0)),be(e)}else c&&N(e),a&&T(e);e.dom.redraw()}function Yo(e,o){const n=k(e),r=e.dom.bounds(),t=Math.pow(r.width/8,2);for(const i of e.pieces.keys()){const s=Te(i,n,r);if(Z(s,o)<=t)return!0}return!1}function Qo(e,o,n,r){const t="a0";e.pieces.set(t,o),e.dom.redraw();const i=B(n);e.draggable.current={orig:t,piece:o,origPos:i,pos:i,started:!0,element:()=>ro(e,t),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},be(e)}function be(e){requestAnimationFrame(()=>{var o;const n=e.draggable.current;if(!n)return;!((o=e.animation.current)===null||o===void 0)&&o.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!se(r,n.piece))J(e);else if(!n.started&&Z(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const i=n.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),n.element=i}const t=e.dom.bounds();D(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==W(n.pos,k(e),t))}be(e)})}function Jo(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=B(o))}function en(e,o){const n=e.draggable.current;if(!n)return;if(o.type==="touchend"&&o.cancelable!==!1&&o.preventDefault(),o.type==="touchend"&&n.originTarget!==o.target&&!n.newPiece){e.draggable.current=void 0;return}N(e),T(e);const r=B(o)||n.pos,t=W(r,k(e),e.dom.bounds());t&&n.started&&n.orig!==t?n.newPiece?Fe(e,n.orig,t,n.force):(e.stats.ctrlKey=o.ctrlKey,je(e,n.orig,t)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!t&&(e.pieces.delete(n.orig),b(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===t||!t)?P(e):e.selectable.enabled||P(e),no(e),e.draggable.current=void 0,e.dom.redraw()}function J(e){const o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,P(e),no(e),e.dom.redraw())}function no(e){const o=e.dom.elements;o.ghost&&pe(o.ghost,!1)}function ro(e,o){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===o&&n.tagName==="PIECE")return n;n=n.nextSibling}}function on(e,o){e.exploding={stage:1,keys:o},e.dom.redraw(),setTimeout(()=>{Me(e,2),setTimeout(()=>Me(e,void 0),120)},120)}function Me(e,o){e.exploding&&(o?e.exploding.stage=o:e.exploding=void 0,e.dom.redraw())}function nn(e,o){function n(){So(e),o()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),Xe(e,r),(r.fen?R:E)(t=>Ye(t,r),e)},state:e,getFen:()=>Ho(e.pieces),toggleOrientation:n,setPieces(r){R(t=>Mo(t,r),e)},selectSquare(r,t){r?R(i=>ce(i,r,t),e):e.selected&&(P(e),e.dom.redraw())},move(r,t){R(i=>Ie(i,r,t),e)},newPiece(r,t){R(i=>he(i,r,t),e)},playPremove(){if(e.premovable.current){if(R($o,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const t=Ko(e,r);return e.dom.redraw(),t}return!1},cancelPremove(){E(N,e)},cancelPredrop(){E(T,e)},cancelMove(){E(r=>{ve(r),J(r)},e)},stop(){E(r=>{Pe(r),J(r)},e)},explode(r){on(e,r)},setAutoShapes(r){E(t=>t.drawable.autoShapes=r,e)},setShapes(r){E(t=>t.drawable.shapes=r,e)},getKeyAtDomPos(r){return W(r,k(e),e.dom.bounds())},redrawAll:o,dragNewPiece(r,t,i){Qo(e,r,t,i)},destroy(){Pe(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function rn(){return{pieces:Ge(Ze),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:bo()}}function le(e,o,n){const r=new Map,t=[];for(const c of e)r.set(c.hash,!1);let i=o.firstChild,s;for(;i;)s=i.getAttribute("cgHash"),r.has(s)?r.set(s,!0):t.push(i),i=i.nextSibling;for(const c of t)o.removeChild(c);for(const c of e)r.get(c.hash)||o.appendChild(n(c))}function M(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function tn(e,o,n){const r=e.drawable,t=r.current,i=t&&t.mouseSq?t:void 0,s=new Map,c=e.dom.bounds(),a=r.autoShapes.filter(u=>!u.piece);for(const u of r.shapes.concat(a).concat(i?[i]:[]))u.dest&&s.set(u.dest,(s.get(u.dest)||0)+1);const l=r.shapes.concat(a).map(u=>({shape:u,current:!1,hash:Ce(u,s,!1,c)}));i&&l.push({shape:i,current:!0,hash:Ce(i,s,!0,c)});const p=l.map(u=>u.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;const d=o.querySelector("defs"),w=o.querySelector("g"),A=n.querySelector("g");sn(r,l,d),le(l.filter(u=>!u.shape.customSvg),w,u=>xe(e,u,r.brushes,s,c)),le(l.filter(u=>u.shape.customSvg),A,u=>xe(e,u,r.brushes,s,c))}function sn(e,o,n){const r=new Map;let t;for(const c of o)c.shape.dest&&(t=e.brushes[c.shape.brush],c.shape.modifiers&&(t=to(t,c.shape.modifiers)),r.set(t.key,t));const i=new Set;let s=n.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[c,a]of r.entries())i.has(c)||n.appendChild(pn(a))}function Ce({orig:e,dest:o,brush:n,piece:r,modifiers:t,customSvg:i},s,c,a){return[a.width,a.height,c,e,o,n,o&&(s.get(o)||0)>1,r&&cn(r),t&&ln(t),i&&an(i)].filter(l=>l).join(",")}function cn(e){return[e.color,e.role,e.scale].filter(o=>o).join(",")}function ln(e){return""+(e.lineWidth||"")}function an(e){let o=0;for(let n=0;n<e.length;n++)o=(o<<5)-o+e.charCodeAt(n)>>>0;return"custom-"+o.toString()}function xe(e,{shape:o,current:n,hash:r},t,i,s){let c;const a=qe(m(o.orig),e.orientation);if(o.customSvg)c=dn(o.customSvg,a,s);else if(o.dest){let l=t[o.brush];o.modifiers&&(l=to(l,o.modifiers)),c=fn(l,a,qe(m(o.dest),e.orientation),n,(i.get(o.dest)||0)>1,s)}else c=un(t[o.brush],a,n,s);return c.setAttribute("cgHash",r),c}function dn(e,o,n){const[r,t]=ee(o,n),i=K(M("g"),{transform:`translate(${r},${t})`}),s=K(M("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(s),s.innerHTML=e,i}function un(e,o,n,r){const t=ee(o,r),i=hn(),s=(r.width+r.height)/(4*Math.max(r.width,r.height));return K(M("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:io(e,n),cx:t[0],cy:t[1],r:s-i[1]/2})}function fn(e,o,n,r,t,i){const s=gn(t&&!r),c=ee(o,i),a=ee(n,i),l=a[0]-c[0],p=a[1]-c[1],d=Math.atan2(p,l),w=Math.cos(d)*s,A=Math.sin(d)*s;return K(M("line"),{stroke:e.color,"stroke-width":mn(e,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:io(e,r),x1:c[0],y1:c[1],x2:a[0]-w,y2:a[1]-A})}function pn(e){const o=K(M("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(K(M("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("cgKey",e.key),o}function K(e,o){for(const n in o)Object.prototype.hasOwnProperty.call(o,n)&&e.setAttribute(n,o[n]);return e}function qe(e,o){return o==="white"?e:[7-e[0],7-e[1]]}function to(e,o){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter(n=>n).join("")}}function hn(){return[3/64,4/64]}function mn(e,o){return(e.lineWidth||10)*(o?.85:1)/64}function io(e,o){return(e.opacity||1)*(o?.9:1)}function gn(e){return(e?20:10)/64}function ee(e,o){const n=Math.min(1,o.width/o.height),r=Math.min(1,o.height/o.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function vn(e,o){e.innerHTML="",e.classList.add("cg-wrap");for(const a of go)e.classList.toggle("orientation-"+a,o.orientation===a);e.classList.toggle("manipulable",!o.viewOnly);const n=O("cg-container");e.appendChild(n);const r=O("cg-board");n.appendChild(r);let t,i,s;if(o.drawable.visible&&(t=K(M("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),t.appendChild(M("defs")),t.appendChild(M("g")),i=K(M("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(M("g")),s=O("cg-auto-pieces"),n.appendChild(t),n.appendChild(i),n.appendChild(s)),o.coordinates){const a=o.orientation==="black"?" black":"",l=o.ranksPosition==="left"?" left":"";n.appendChild(De(de,"ranks"+a+l)),n.appendChild(De(ae,"files"+a))}let c;return o.draggable.enabled&&o.draggable.showGhost&&(c=O("piece","ghost"),pe(c,!1),n.appendChild(c)),{board:r,container:n,wrap:e,ghost:c,svg:t,customSvg:i,autoPieces:s}}function De(e,o){const n=O("coords",o);let r;for(const t of e)r=O("coord"),r.textContent=t,n.appendChild(r);return n}function wn(e,o){if(!e.dropmode.active)return;N(e),T(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=B(o),t=r&&W(r,k(e),e.dom.bounds());t&&Fe(e,"a0",t)}e.dom.redraw()}function bn(e,o){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(o).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",t=>t.preventDefault()),e.viewOnly)return;const r=yn(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function kn(e,o){const n=[];if("ResizeObserver"in window||n.push(V(document.body,"chessground.resize",o)),!e.viewOnly){const r=Ae(e,Jo,Fo),t=Ae(e,en,Vo);for(const s of["touchmove","mousemove"])n.push(V(document,s,r));for(const s of["touchend","mouseup"])n.push(V(document,s,t));const i=()=>e.dom.bounds.clear();n.push(V(document,"scroll",i,{capture:!0,passive:!0})),n.push(V(window,"resize",i,{passive:!0}))}return()=>n.forEach(r=>r())}function V(e,o,n,r){return e.addEventListener(o,n,r),()=>e.removeEventListener(o,n,r)}const yn=e=>o=>{e.draggable.current?J(e):e.drawable.current?eo(e):o.shiftKey||Ne(o)?e.drawable.enabled&&jo(e,o):e.viewOnly||(e.dropmode.active?wn(e,o):Xo(e,o))},Ae=(e,o,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||o(e,r)};function Pn(e){const o=k(e),n=G(e.dom.bounds()),r=e.dom.elements.board,t=e.pieces,i=e.animation.current,s=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,a=e.draggable.current,l=Mn(e),p=new Set,d=new Set,w=new Map,A=new Map;let u,f,g,L,S,j,oe,C,ne,X;for(f=r.firstChild;f;){if(u=f.cgKey,so(f))if(g=t.get(u),S=s.get(u),j=c.get(u),L=f.cgPiece,f.cgDragging&&(!a||a.orig!==u)&&(f.classList.remove("dragging"),D(f,n(m(u),o)),f.cgDragging=!1),!j&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),g){if(S&&f.cgAnimating&&L===U(g)){const h=m(u);h[0]+=S[2],h[1]+=S[3],f.classList.add("anim"),D(f,n(h,o))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),D(f,n(m(u),o)),e.addPieceZIndex&&(f.style.zIndex=te(m(u),o)));L===U(g)&&(!j||!f.cgFading)?p.add(u):j&&L===U(j)?(f.classList.add("fading"),f.cgFading=!0):ie(w,L,f)}else ie(w,L,f);else if(co(f)){const h=f.className;l.get(u)===h?d.add(u):ie(A,h,f)}f=f.nextSibling}for(const[h,F]of l)if(!d.has(h)){ne=A.get(F),X=ne&&ne.pop();const x=n(m(h),o);if(X)X.cgKey=h,D(X,x);else{const q=O("square",F);q.cgKey=h,D(q,x),r.insertBefore(q,r.firstChild)}}for(const[h,F]of t)if(S=s.get(h),!p.has(h))if(oe=w.get(U(F)),C=oe&&oe.pop(),C){C.cgKey=h,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);const x=m(h);e.addPieceZIndex&&(C.style.zIndex=te(x,o)),S&&(C.cgAnimating=!0,C.classList.add("anim"),x[0]+=S[2],x[1]+=S[3]),D(C,n(x,o))}else{const x=U(F),q=O("piece",x),Y=m(h);q.cgPiece=x,q.cgKey=h,S&&(q.cgAnimating=!0,Y[0]+=S[2],Y[1]+=S[3]),D(q,n(Y,o)),e.addPieceZIndex&&(q.style.zIndex=te(Y,o)),r.appendChild(q)}for(const h of w.values())ze(e,h);for(const h of A.values())ze(e,h)}function Sn(e){const o=k(e),n=G(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(so(r)&&!r.cgAnimating||co(r))&&D(r,n(m(r.cgKey),o)),r=r.nextSibling}function Oe(e){var o,n;const r=e.dom.elements.wrap.getBoundingClientRect(),t=e.dom.elements.container,i=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=s*i;t.style.width=s+"px",t.style.height=c+"px",e.dom.bounds.clear(),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",c+"px")}const so=e=>e.tagName==="PIECE",co=e=>e.tagName==="SQUARE";function ze(e,o){for(const n of o)e.dom.elements.board.removeChild(n)}function te(e,o){const r=e[1];return`${o?3+7-r:3+r}`}const U=e=>`${e.color} ${e.role}`;function Mn(e){var o;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const i of e.lastMove)z(n,i,"last-move");if(e.check&&e.highlight.check&&z(n,e.check,"check"),e.selected&&(z(n,e.selected,"selected"),e.movable.showDests)){const i=(o=e.movable.dests)===null||o===void 0?void 0:o.get(e.selected);if(i)for(const c of i)z(n,c,"move-dest"+(e.pieces.has(c)?" oc":""));const s=e.premovable.dests;if(s)for(const c of s)z(n,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}const r=e.premovable.current;if(r)for(const i of r)z(n,i,"current-premove");else e.predroppable.current&&z(n,e.predroppable.current.key,"current-premove");const t=e.exploding;if(t)for(const i of t.keys)z(n,i,"exploding"+t.stage);return n}function z(e,o,n){const r=e.get(o);r?e.set(o,`${r} ${n}`):e.set(o,n)}function ie(e,o,n){const r=e.get(o);r?r.push(n):e.set(o,[n])}function Cn(e,o){const r=e.drawable.autoShapes.filter(t=>t.piece).map(t=>({shape:t,hash:Dn(t),current:!1}));le(r,o,t=>qn(e,t,e.dom.bounds()))}function xn(e){var o;const n=k(e),r=G(e.dom.bounds());let t=(o=e.dom.elements.autoPieces)===null||o===void 0?void 0:o.firstChild;for(;t;)Ke(t,r(m(t.cgKey),n),t.cgScale),t=t.nextSibling}function qn(e,{shape:o,hash:n},r){var t,i,s;const c=o.orig,a=(t=o.piece)===null||t===void 0?void 0:t.role,l=(i=o.piece)===null||i===void 0?void 0:i.color,p=(s=o.piece)===null||s===void 0?void 0:s.scale,d=O("piece",`${a} ${l}`);return d.setAttribute("cgHash",n),d.cgKey=c,d.cgScale=p,Ke(d,G(r)(m(c),k(e)),p),d}const Dn=e=>{var o,n,r;return[e.orig,(o=e.piece)===null||o===void 0?void 0:o.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function An(e,o){const n=rn();Ye(n,o||{});function r(){const t="dom"in n?n.dom.unbind:void 0,i=vn(e,n),s=wo(()=>i.board.getBoundingClientRect()),c=p=>{Pn(l),i.autoPieces&&Cn(l,i.autoPieces),!p&&i.svg&&tn(l,i.svg,i.customSvg)},a=()=>{Oe(l),Sn(l),i.autoPieces&&xn(l)},l=n;return l.dom={elements:i,bounds:s,redraw:On(c),redrawNow:c,unbind:t},l.drawable.prevSvgHash="",Oe(l),c(!1),bn(l,a),t||(l.dom.unbind=kn(l,a)),l.events.insert&&l.events.insert(i),l}return nn(r(),r)}function On(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame(()=>{e(),o=!1}))}}const zn=ho('<div class="is2d"><div> </div></div>'),jn=e=>{let[o,n]=fo(void 0,{equals:!1}),r;ke(ye(()=>(o(),e.glyphs),s=>{r&&(s?r.setAutoShapes(s.map(c=>({orig:c.orig,customSvg:En[c.glyph]}))):r.setAutoShapes([]))}));let t=new Map;ke(ye(()=>(o(),e.fen),s=>{if(!r||!s)return;t=new Map,new mo.Chess(s).moves({verbose:!0}).forEach(a=>{t.get(a.from)||t.set(a.from,[]),t.get(a.from).push(a.to)}),r==null||r.set({fen:s,movable:{dests:t}})}));let i={viewOnly:!e.onUserMove,orientation:e.isBlack?"black":"white",movable:{free:!1,dests:t},events:{move(s,c){var a;(a=e.onUserMove)==null||a.call(e,s+c)}}};return(()=>{const s=zn.cloneNode(!0),c=s.firstChild;return po(a=>setTimeout(()=>{r=An(a,i),n()}),c),s})()},I=e=>`
<defs>
  <filter id="shadow">
    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />
  </filter>
</defs>`+e,En={"?!":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#56b4e9;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M37.734 21.947c-3.714 0-7.128.464-10.242 1.393-3.113.928-6.009 2.13-8.685 3.605l4.343 8.766c2.35-1.202 4.644-2.157 6.883-2.867a22.366 22.366 0 0 1 6.799-1.065c2.294 0 4.07.464 5.326 1.393 1.311.874 1.967 2.186 1.967 3.933 0 1.748-.546 3.277-1.639 4.588-1.038 1.257-2.786 2.758-5.244 4.506-2.786 2.021-4.751 3.961-5.898 5.819-1.147 1.857-1.721 4.15-1.721 6.88v2.952h10.568v-2.377c0-1.147.137-2.103.41-2.868.328-.764.93-1.557 1.803-2.376.874-.82 2.104-1.803 3.688-2.95 2.13-1.584 3.906-3.058 5.326-4.424 1.42-1.42 2.485-2.95 3.195-4.59.71-1.638 1.065-3.576 1.065-5.816 0-4.206-1.584-7.675-4.752-10.406-3.114-2.731-7.51-4.096-13.192-4.096zm24.745.819l2.048 39.084h9.75l2.047-39.084zM35.357 68.73c-1.966 0-3.632.52-4.998 1.557-1.365.983-2.047 2.732-2.047 5.244 0 2.404.682 4.152 2.047 5.244 1.366 1.038 3.032 1.557 4.998 1.557 1.912 0 3.55-.519 4.916-1.557 1.366-1.092 2.05-2.84 2.05-5.244 0-2.512-.684-4.26-2.05-5.244-1.365-1.038-3.004-1.557-4.916-1.557zm34.004 0c-1.966 0-3.632.52-4.998 1.557-1.365.983-2.049 2.732-2.049 5.244 0 2.404.684 4.152 2.05 5.244 1.365 1.038 3.03 1.557 4.997 1.557 1.912 0 3.55-.519 4.916-1.557 1.366-1.092 2.047-2.84 2.047-5.244 0-2.512-.681-4.26-2.047-5.244-1.365-1.038-3.004-1.557-4.916-1.557z"/>
</g>
`),"?":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#e69f00;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M40.436 60.851q0-4.66 1.957-7.83 1.958-3.17 6.712-6.619 4.195-2.983 5.967-5.127 1.864-2.237 1.864-5.22 0-2.983-2.237-4.475-2.144-1.585-6.06-1.585-3.915 0-7.737 1.212t-7.83 3.263l-4.941-9.975q4.568-2.517 9.881-4.101 5.314-1.585 11.653-1.585 9.695 0 15.008 4.661 5.407 4.661 5.407 11.839 0 3.822-1.212 6.619-1.212 2.796-3.635 5.22-2.424 2.33-6.06 5.034-2.703 1.958-4.195 3.356-1.491 1.398-2.05 2.703-.467 1.305-.467 3.263v2.703H40.436zm-1.492 18.924q0-4.288 2.33-5.966 2.331-1.771 5.687-1.771 3.263 0 5.594 1.771 2.33 1.678 2.33 5.966 0 4.102-2.33 5.966-2.331 1.772-5.594 1.772-3.356 0-5.686-1.772-2.33-1.864-2.33-5.966z"/>
</g>
`),"??":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M31.8 22.22c-3.675 0-7.052.46-10.132 1.38-3.08.918-5.945 2.106-8.593 3.565l4.298 8.674c2.323-1.189 4.592-2.136 6.808-2.838a22.138 22.138 0 0 1 6.728-1.053c2.27 0 4.025.46 5.268 1.378 1.297.865 1.946 2.16 1.946 3.89s-.541 3.242-1.622 4.539c-1.027 1.243-2.756 2.73-5.188 4.458-2.756 2-4.7 3.918-5.836 5.755-1.134 1.837-1.702 4.107-1.702 6.808v2.92h10.457v-2.35c0-1.135.135-2.082.406-2.839.324-.756.918-1.54 1.783-2.35.864-.81 2.079-1.784 3.646-2.918 2.107-1.568 3.863-3.026 5.268-4.376 1.405-1.405 2.46-2.92 3.162-4.541.703-1.621 1.054-3.54 1.054-5.755 0-4.161-1.568-7.592-4.702-10.294-3.08-2.702-7.43-4.052-13.05-4.052zm38.664 0c-3.675 0-7.053.46-10.133 1.38-3.08.918-5.944 2.106-8.591 3.565l4.295 8.674c2.324-1.189 4.593-2.136 6.808-2.838a22.138 22.138 0 0 1 6.728-1.053c2.27 0 4.026.46 5.269 1.378 1.297.865 1.946 2.16 1.946 3.89s-.54 3.242-1.62 4.539c-1.027 1.243-2.757 2.73-5.189 4.458-2.756 2-4.7 3.918-5.835 5.755-1.135 1.837-1.703 4.107-1.703 6.808v2.92h10.457v-2.35c0-1.135.134-2.082.404-2.839.324-.756.918-1.54 1.783-2.35.865-.81 2.081-1.784 3.648-2.918 2.108-1.568 3.864-3.026 5.269-4.376 1.405-1.405 2.46-2.92 3.162-4.541.702-1.621 1.053-3.54 1.053-5.755 0-4.161-1.567-7.592-4.702-10.294-3.08-2.702-7.43-4.052-13.05-4.052zM29.449 68.504c-1.945 0-3.593.513-4.944 1.54-1.351.973-2.027 2.703-2.027 5.188 0 2.378.676 4.108 2.027 5.188 1.35 1.027 3 1.54 4.944 1.54 1.892 0 3.512-.513 4.863-1.54 1.35-1.08 2.026-2.81 2.026-5.188 0-2.485-.675-4.215-2.026-5.188-1.351-1.027-2.971-1.54-4.863-1.54zm38.663 0c-1.945 0-3.592.513-4.943 1.54-1.35.973-2.026 2.703-2.026 5.188 0 2.378.675 4.108 2.026 5.188 1.351 1.027 2.998 1.54 4.943 1.54 1.891 0 3.513-.513 4.864-1.54 1.351-1.08 2.027-2.81 2.027-5.188 0-2.485-.676-4.215-2.027-5.188-1.35-1.027-2.973-1.54-4.864-1.54z"/>
</g>
`),"!?":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#ea45d8;filter:url(#shadow)" cx="50" cy="50" r="50"/>
    <path fill="#fff" d="M60.823 58.9q0-4.098 1.72-6.883 1.721-2.786 5.9-5.818 3.687-2.622 5.243-4.506 1.64-1.966 1.64-4.588t-1.967-3.933q-1.885-1.393-5.326-1.393t-6.8 1.065q-3.36 1.065-6.883 2.868l-4.343-8.767q4.015-2.212 8.685-3.605 4.67-1.393 10.242-1.393 8.521 0 13.192 4.097 4.752 4.096 4.752 10.405 0 3.36-1.065 5.818-1.066 2.458-3.196 4.588-2.13 2.048-5.326 4.424-2.376 1.72-3.687 2.95-1.31 1.229-1.802 2.376-.41 1.147-.41 2.868v2.376h-10.57zm-1.311 16.632q0-3.77 2.048-5.244 2.049-1.557 4.998-1.557 2.868 0 4.916 1.557 2.049 1.475 2.049 5.244 0 3.605-2.049 5.244-2.048 1.556-4.916 1.556-2.95 0-4.998-1.556-2.048-1.64-2.048-5.244zM36.967 61.849h-9.75l-2.049-39.083h13.847zM25.004 75.532q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>
</g>
`),"!":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#22ac38;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M54.967 62.349h-9.75l-2.049-39.083h13.847zM43.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>
</g>
`),"!!":I(`
<g transform="translate(77 -18) scale(0.4)">
  <circle style="fill:#168226;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M71.967 62.349h-9.75l-2.049-39.083h13.847zM60.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244zM37.967 62.349h-9.75l-2.049-39.083h13.847zM26.004 76.032q0-3.77 2.049-5.244 2.048-1.557 4.998-1.557 2.867 0 4.916 1.557 2.048 1.475 2.048 5.244 0 3.605-2.048 5.244-2.049 1.556-4.916 1.556-2.95 0-4.998-1.556-2.049-1.64-2.049-5.244z" vector-effect="non-scaling-stroke"/>
</g>
`)},Q=e=>e!==void 0,$n=6,Kn=245;class Nn{constructor(){v(this,"engineName");v(this,"work");v(this,"currentEval");v(this,"expectedPvs",1);v(this,"nextWork");v(this,"send");v(this,"options",new Map)}connected(o){this.send=o,this.options=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]),this.send("uci")}setOption(o,n){n=n.toString(),this.send&&this.options.get(o)!==n&&(this.send(`setoption name ${o} value ${n}`),this.options.set(o,n))}disconnected(){this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,this.send=void 0}received(o){var r,t;const n=o.trim().split(/\s+/g);if(n[0]==="uciok")this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true"),(r=this.send)==null||r.call(this,"ucinewgame"),(t=this.send)==null||t.call(this,"isready");else if(n[0]==="readyok")this.swapWork();else if(n[0]==="id"&&n[1]==="name")this.engineName=n.slice(2).join(" ");else if(n[0]==="bestmove"){this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,this.swapWork();return}else if(this.work&&!this.work.stopRequested&&n[0]==="info"){let i=0,s,c=1,a,l,p=!1,d,w=[];for(let g=1;g<n.length;g++)switch(n[g]){case"depth":i=parseInt(n[++g]);break;case"nodes":s=parseInt(n[++g]);break;case"multipv":c=parseInt(n[++g]);break;case"time":a=parseInt(n[++g]);break;case"score":p=n[++g]==="mate",d=parseInt(n[++g]),(n[g+1]==="lowerbound"||n[g+1]==="upperbound")&&(l=n[++g]);break;case"pv":w=n.slice(++g),g=n.length;break}if(p&&!d||(this.expectedPvs<c&&(this.expectedPvs=c),i<$n||!Q(s)||!Q(a)||!Q(p)||!Q(d)))return;const A=this.work.threatMode?0:1,u=this.work.ply%2===A?-d:d;if(l&&c===1)return;const f={moves:w,cp:p?void 0:u,mate:p?u:void 0,depth:i};c===1?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:i,knps:s/a,nodes:s,cp:p?void 0:u,mate:p?u:void 0,pvs:[f],millis:a}:this.currentEval&&(this.currentEval.pvs.push(f),this.currentEval.depth=Math.min(this.currentEval.depth,i)),c===this.expectedPvs&&this.currentEval&&(this.work.emit(this.currentEval),i>=this.work.maxDepth&&a>8e3&&s>4e3*Math.exp(this.work.maxDepth*.3)&&this.stop())}}stop(){var o;this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,(o=this.send)==null||o.call(this,"stop"))}swapWork(){!this.send||this.work||(this.work=this.nextWork,this.nextWork=void 0,this.work&&(this.currentEval=void 0,this.expectedPvs=1,this.setOption("Threads",this.work.threads),this.setOption("Hash",this.work.hashSize||16),this.setOption("MultiPV",Math.max(1,this.work.multiPv)),this.send(["position fen",this.work.initialFen,"moves",...this.work.moves].join(" ")),this.send(this.work.maxDepth>=99?`go depth ${Kn}`:"go movetime 90000")))}compute(o){this.nextWork=o,this.stop(),this.swapWork()}isComputing(){return!!this.work&&!this.work.stopRequested}}const Tn=e=>e,Rn=e=>new Promise((o,n)=>{let r=document.createElement("script");r.onload=()=>{o(void 0)},r.onerror=t=>{n(t)},r.src=e,document.head.append(r)}),$=class{constructor(o){this.opts=o}getState(){return $.sf.Stockfish?$.failed.Stockfish?4:this.getProtocol().engineName?this.getProtocol().isComputing()?3:2:1:0}getProtocol(){return $.protocols.Stockfish}async boot(){let o="http://"+window.location.host+"/vendor/stockfish-nnue.wasm/";o="https://"+window.location.host+"/vendor/stockfish-nnue.wasm/";const n=o+"stockfish.wasm";let r;r=await new Promise((s,c)=>{fetch(n).then(a=>a.arrayBuffer()).then(a=>s(a))}),await Rn(o+"stockfish.js");const t=await window.Stockfish({wasmBinary:r,locateFile:s=>Tn(o+s),wasmMemory:this.opts.wasmMemory}),i=this.getProtocol();return t.addMessageListener(i.received.bind(i)),i.connected(s=>t.postMessage(s)),t}start(o){this.getProtocol().compute(o),$.sf.Stockfish||($.sf.Stockfish=this.boot().then(()=>{},n=>{console.error(n),$.failed.Stockfish=!0}))}stop(){this.getProtocol().compute(void 0)}destroy(){this.stop()}};let _=$;v(_,"failed",{Stockfish:!1}),v(_,"protocols",{Stockfish:new Nn}),v(_,"sf",{});const Ee="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";function Hn(e){return!!(e.startsWith("O-O")||e.includes("x")||e.toLowerCase()===e)}const lo=(e,o)=>{for(;;)try{return new WebAssembly.Memory({shared:!0,initial:e,maximum:o})}catch(n){if(n instanceof RangeError){if(e===o)throw n;o=Math.max(e,Math.floor(o/2))}else throw n}},Bn=()=>{let e="wasm";Wn(1,2);const o=1,n=()=>128;return{technology:e,growableSharedMem:!1,supportsNnue:!1,maxThreads:o,maxWasmPages:r=>Math.max(r,32768),maxHashSize:()=>n()}};function Wn(e,o){if(typeof SharedArrayBuffer!="function")return;const n=lo(e,o);if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n.buffer,"*")}catch{return}return n}}class Fn{constructor(o){v(this,"worker");v(this,"platform");v(this,"start",(o,n)=>{this.doStart(o,n)});v(this,"doStart",(o,n)=>{var s;const r=n[n.length-1],t=8,i={threads:1,hashSize:this.hashSize(),stopRequested:!1,initialFen:((s=n[0])==null?void 0:s.fen)||Ee,moves:[],currentFen:(r==null?void 0:r.fen)||Ee,path:o,ply:(r==null?void 0:r.ply)||0,maxDepth:t,multiPv:3,threatMode:!1,emit:c=>{this.opts.emit(c,i)}};for(let c=1;c<n.length;c++){const a=n[c];Hn(a.san)?(i.moves=[],i.initialFen=a.fen):i.moves.push(a.uci)}this.worker||(this.worker=new _({wasmMemory:lo(2048,this.platform.maxWasmPages(2048))})),this.worker.start(i)});v(this,"stop",()=>{var o;(o=this.worker)==null||o.stop()});v(this,"hashSize",()=>this.platform.maxHashSize());this.opts=o,this.platform=Bn()}}export{Fn as C,jn as G};
