var tt=(r,e)=>{let t=[];for(let i in r)e(i,r[i])&&t.push(i);return t},ce=(r,e)=>{for(let t in r)if(e(t,r[t]))return t},S=(r,e)=>{let t={};for(let i in r){let s=r[i]&&e(i,r[i]);t[i]=s}return t},ue=r=>{let e={};return r.forEach(t=>e[t]=t),e},it=(r,e)=>{let t={};return r.forEach(i=>{let s=e(i);s&&(t[i]=s)}),t},F=["a","b","c","d","e","f","g","h"],J=["1","2","3","4","5","6","7","8"],rt=["w","b"],st=["r","q","b","n","p","k"],nt=["q","n","r","b"],D=F.flatMap(r=>J.map(e=>`${r}${e}`)),ot=rt.flatMap(r=>st.map(e=>r+e));ot.flatMap(r=>D.map(e=>[r,e].join("@")));var at=J.slice(0).reverse();J.flatMap(r=>F.map(e=>`${e}${r}`));at.flatMap(r=>F.map(e=>`${e}${r}`));D.flatMap(r=>D.map(e=>`${r}${e}`));var Z=ue(F),V=ue(J),X={a:"b",b:"c",c:"d",d:"e",e:"f",f:"g",g:"h",h:void 0},ee={h:"g",g:"f",f:"e",e:"d",d:"c",c:"b",b:"a",a:void 0},te={1:"2",2:"3",3:"4",4:"5",5:"6",6:"7",7:"8",8:void 0},ie={8:"7",7:"6",6:"5",5:"4",4:"3",3:"2",2:"1",1:void 0};function re(r,e){return S(r,t=>{let i=e[t];if(i&&(i=e[i],i))return i})}var Te=re(Z,X),Ie=re(Z,ee),Pe=re(V,te),qe=re(V,ie);function se(r,e){return S(r,t=>{let i={},s=t,n=[];for(;s=e[s];)i[s]=n.slice(0),n.push(s);return i})}var _e=se(Z,X),de=se(Z,ee),pe=se(V,te),me=se(V,ie),A=ue(D),lt=r=>[r.slice(0,2),r.slice(2)],B=r=>r.split("");function Me(r){return S(A,e=>{let[t,i]=B(e),s={},n=r[t];return S(n,(l,o)=>{let a=o.map(f=>f+i);s[l+i]=a}),s})}var Re=Me(_e),xe=Me(de);function Oe(r){return S(A,e=>{let[t,i]=B(e),s={},n=r[i];return S(n,(l,o)=>{let a=o.map(f=>t+f);s[t+l]=a}),s})}var ge=Oe(pe),ve=Oe(me);function ht(r,e){return r.map((t,i)=>t+e[i])}function ne(r,e){return S(A,t=>{let[i,s]=B(t),n={},l=r[s],o=e[i];return S(l,(a,f)=>{let d=ce(o,(g,h)=>o[g].length===l[a].length);if(d){let g=ht(o[d],l[a]);n[d+a]=g}}),n})}var Le=ne(pe,de),Ke=ne(pe,_e),Fe=ne(me,de),$e=ne(me,_e);function x(r,e){return S(A,t=>{let[i,s]=B(t);return ce(A,n=>{let[l,o]=B(n);return e[i]===l&&r[s]===o})})}var ft=x(Pe,ee),ct=x(Pe,X),ut=x(te,Ie),_t=x(te,Te),dt=x(qe,ee),pt=x(qe,X),mt=x(ie,Ie),gt=x(ie,Te);function De(r,e){return S(A,t=>{const i=ce(r[t],s=>r[t][s].length===e);if(i)return S(A,s=>{if(s===i)return r[t][i]})})}var Qe=r=>De(r,1),O=r=>De(r,0),vt=Qe(ge),bt=Qe(ve),Ue=O(ge),je=O(ve),Be=O(Le),Ge=O(Ke),He=O(Fe),We=O($e),kt=O(Re),Et=O(xe);function St(r){return S(A,e=>{let t=tt(A,i=>!!r.map(s=>s[e]===i).find(Boolean));if(t.length>0)return t})}St([ft,ct,dt,pt,ut,_t,mt,gt]);function N(r){return S(A,e=>S(A,t=>{let i=r.find(s=>{var n;return(n=s[e])==null?void 0:n[t]});if(i){let s=i[e];if(s){let n=s[t];if(n)return n}}}))}var wt=N([Ue,Be,Ge]),Ct=N([je,He,We]),At=N([Et,kt]),yt=N([Le,Ke,Fe,$e]),Nt=N([ge,ve,xe,Re]);N([wt,Ct,At]);N([yt,Nt]);var Tt=r=>r.split("")[1]==="2",It=r=>r.split("")[1]==="7",ze=r=>r.split("")[1]!=="1",Ye=r=>r.split("")[1]!=="8";function Q(r,e){return S(A,t=>{if(e(t)&&r[t])return r[t]})}var Pt=Q(vt,Tt),qt=Q(bt,It),Mt=Q(Ue,ze),Rt=Q(je,Ye);N([Pt,Mt]);N([qt,Rt]);Q(N([Ge,Be]),ze);Q(N([We,He]),Ye);F.slice(0).reverse(),F.slice(0);var ti="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",xt=r=>r.split("="),Je=35,Ze=String.fromCharCode(33),Ot=r=>D.indexOf(r)+1,Ve=it(D,r=>String.fromCharCode(Ot(r)+Je)),ae=r=>Ve[r]||Ze,Lt=(()=>{let r={};return nt.map((e,t)=>{F.map((i,s)=>{let n=e+i,l=String.fromCharCode(Je+Object.keys(Ve).length+t*8+s-1);r[n]=l})}),r})(),Kt=(r,e)=>Lt[e+r]||Ze,Ft=r=>{let[e,t]=xt(r),[i,s]=lt(e);return t?ae(i)+Kt(s[0],t):ae(i)+ae(s)},Ee=r=>r.length/2,Se=r=>r.slice(0,2),we=r=>r.slice(2),Xe=r=>r.slice(0,-2),$t=r=>r.slice(-2),L=class{constructor(r,e,t,i,s){this.id=r,this.fen=e,this.uci=i,this.comment=s,this.child_by_id=n=>this.children.find(l=>l.id===n),this.children=t}get clone(){let r=this.children.map(e=>e.clone);return new L(this.id,this.fen,r,this.uci,this.comment)}get child_paths(){let r=this.children.flatMap(e=>e.child_paths);return r.length===0?[this.id]:r.map(e=>`${this.id}${e}`)}get lines(){return this.child_paths.map(r=>this.node_list(r))}node_list(r){return L.collect(this,e=>{const t=Se(r);if(t!=="")return r=we(r),e.child_by_id(t)})}map_comments(r){let e=this.children.map(i=>i.map_comments(r)),t=r(this);return new L(this.id,this.fen,e,this.uci,t)}merge_node(r,e){const t=`${e}${r.id}`,i=this.node_at_path_or_undefined(t);return this.update_at(e,s=>{if(i){let n=i.comment;n?r.comment&&(n+=" "+r.comment):n=r.comment;let l=new L(i.id,i.fen,i.children,i.uci,n);s.children.splice(s.children.indexOf(i),1,l)}else s.children.push(r)})?t:void 0}delete_siblings(r){let e=$t(r),t=Xe(r);this.update_at(t,i=>{i.children=i.children.filter(s=>s.id===e)})}delete_children(r){this.update_at(r,e=>{e.children.splice(0,e.children.length)})}delete_after(r,e){this.update_at(r,t=>{t.children.splice(t.children.findIndex(i=>i.id===e),1)})}add_node(r,e){const t=`${e}${r.id}`;return this.node_at_path_or_undefined(t)||this.update_at(e,s=>{s.children.push(r)})?t:void 0}update_at(r,e){let t=this.node_at_path_or_undefined(r);if(t)return e(t),t}node_at_path_or_undefined(r){if(r==="")return this;const e=this.child_by_id(Se(r));return e?e.node_at_path_or_undefined(we(r)):void 0}},U=L;U.collect=(r,e)=>{let t=[r],i=r,s;for(;s=e(i);)t.push(s),i=s;return t};U.breadfirst=(r,e)=>{let t=[["",r]];for(;t.length>0;){let[i,s]=t.shift();if(e(i,s))break;for(let n=0;n<s.children.length;n++)t.push([i+s.children[n].id,s.children[n]])}};U.make_root=(r,e)=>new L("",r,[],void 0,e);U.make_branch=(r,e,t)=>new L(Ft(e),r,[],e,t);var G=class{},j=G;j.write_root=r=>({fen:r.fen,comment:r.comment});j.read_root=r=>U.make_root(r.fen,r.comment);j.write_node=r=>({fen:r.fen,uci:r.uci,comment:r.comment});j.read_node=r=>U.make_branch(r.fen,r.uci,r.comment);j.read=r=>{let[e,t]=r;t.sort((s,n)=>Ee(s[0])-Ee(n[0]));let i=G.read_root(e);return t.forEach(([s,n])=>i.add_node(G.read_node(n),Xe(s))),i};j.apply=r=>{function e(t,i){let s=`${i}${t.id}`;return[...t.children.flatMap(n=>e(n,s)),[s,G.write_node(t)]]}return[G.write_root(r),r.children.flatMap(t=>e(t,""))]};/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const y="w",I="b",E="p",fe="n",Y="b",Dt="r",Qt="q",P="k",le="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",T=-1,Ut={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},u={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},p={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},he={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ce={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},jt=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Bt=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Gt={p:1,n:2,b:4,r:8,q:16,k:32},Ht="pnbrqkPNBRQK",Ae=[fe,Y,Dt,Qt],Wt=7,zt=6,Yt=1,Jt=0,M={w:[{square:p.a1,flag:u.QSIDE_CASTLE},{square:p.h1,flag:u.KSIDE_CASTLE}],b:[{square:p.a8,flag:u.QSIDE_CASTLE},{square:p.h8,flag:u.KSIDE_CASTLE}]},Zt={b:Yt,w:zt},Vt=["1-0","0-1","1/2-1/2","*"];function K(r){return r>>4}function H(r){return r&15}function et(r){return"0123456789".indexOf(r)!==-1}function w(r){const e=H(r),t=K(r);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function z(r){return r===y?I:y}function Xt(r){const e=r.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(e[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const s=e[0].split("/");if(s.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let l=0;l<s.length;l++){let o=0,a=!1;for(let f=0;f<s[l].length;f++)if(et(s[l][f])){if(a)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(s[l][f],10),a=!0}else{if(!/^[prnbqkPRNBQK]$/.test(s[l][f]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,a=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:l,regex:o}of n){if(!o.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${l} king`};if((e[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${l} kings`}}return{ok:!0}}function ei(r,e){const t=r.from,i=r.to,s=r.piece;let n=0,l=0,o=0;for(let a=0,f=e.length;a<f;a++){const d=e[a].from,g=e[a].to,h=e[a].piece;s===h&&t!==d&&i===g&&(n++,K(t)===K(d)&&l++,H(t)===H(d)&&o++)}return n>0?l>0&&o>0?w(t):o>0?w(t).charAt(1):w(t).charAt(0):""}function R(r,e,t,i,s,n=void 0,l=u.NORMAL){const o=K(i);if(s===E&&(o===Wt||o===Jt))for(let a=0;a<Ae.length;a++){const f=Ae[a];r.push({color:e,from:t,to:i,piece:s,captured:n,promotion:f,flags:l|u.PROMOTION})}else r.push({color:e,from:t,to:i,piece:s,captured:n,flags:l})}function ye(r){let e=r.charAt(0);return e>="a"&&e<="h"?r.match(/[a-h]\d.*[a-h]\d/)?void 0:E:(e=e.toLowerCase(),e==="o"?P:e)}function Ne(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class ii{constructor(e=le){this._board=new Array(128),this._turn=y,this._header={},this._kings={w:T,b:T},this._epSquare=-1,this._halfMoves=0,this._moveNumber=0,this._history=[],this._comments={},this._castling={w:0,b:0},this.load(e)}clear(e=!1){this._board=new Array(128),this._kings={w:T,b:T},this._turn=y,this._castling={w:0,b:0},this._epSquare=T,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._updateSetup(this.fen())}load(e,t=!1){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){const a=["-","-","0","1"];e=i.concat(a.slice(-(6-i.length))).join(" ")}i=e.split(/\s+/);const{ok:s,error:n}=Xt(e);if(!s)throw new Error(n);const l=i[0];let o=0;this.clear(t);for(let a=0;a<l.length;a++){const f=l.charAt(a);if(f==="/")o+=8;else if(et(f))o+=parseInt(f,10);else{const d=f<"a"?y:I;this.put({type:f.toLowerCase(),color:d},w(o)),o++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=u.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=u.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=u.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=u.QSIDE_CASTLE),this._epSquare=i[3]==="-"?T:p[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._updateSetup(this.fen())}fen(){var e,t;let i=0,s="";for(let o=p.a8;o<=p.h1;o++){if(this._board[o]){i>0&&(s+=i,i=0);const{color:a,type:f}=this._board[o];s+=a===y?f.toUpperCase():f.toLowerCase()}else i++;o+1&136&&(i>0&&(s+=i),o!==p.h1&&(s+="/"),i=0,o+=8)}let n="";this._castling[y]&u.KSIDE_CASTLE&&(n+="K"),this._castling[y]&u.QSIDE_CASTLE&&(n+="Q"),this._castling[I]&u.KSIDE_CASTLE&&(n+="k"),this._castling[I]&u.QSIDE_CASTLE&&(n+="q"),n=n||"-";let l="-";if(this._epSquare!==T){const o=this._epSquare+(this._turn===y?16:-16),a=[o+1,o-1];for(const f of a){if(f&136)continue;const d=this._turn;if(((e=this._board[f])===null||e===void 0?void 0:e.color)===d&&((t=this._board[f])===null||t===void 0?void 0:t.type)===E){this._makeMove({color:d,from:f,to:this._epSquare,piece:E,captured:E,flags:u.EP_CAPTURE});const g=!this._isKingAttacked(d);if(this._undoMove(),g){l=w(this._epSquare);break}}}}return[s,this._turn,n,l,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==le?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(le)}get(e){return this._board[p[e]]||!1}put({type:e,color:t},i){if(Ht.indexOf(e.toLowerCase())===-1||!(i in p))return!1;const s=p[i];return e==P&&!(this._kings[t]==T||this._kings[t]==s)?!1:(this._board[s]={type:e,color:t},e===P&&(this._kings[t]=s),this._updateSetup(this.fen()),!0)}remove(e){const t=this.get(e);return delete this._board[p[e]],t&&t.type===P&&(this._kings[t.color]=T),this._updateSetup(this.fen()),t}_attacked(e,t){for(let i=p.a8;i<=p.h1;i++){if(i&136){i+=7;continue}if(this._board[i]===void 0||this._board[i].color!==e)continue;const s=this._board[i],n=i-t;if(n===0)continue;const l=n+119;if(jt[l]&Gt[s.type]){if(s.type===E){if(n>0){if(s.color===y)return!0}else if(s.color===I)return!0;continue}if(s.type==="n"||s.type==="k")return!0;const o=Bt[l];let a=i+o,f=!1;for(;a!==t;){if(this._board[a]!=null){f=!0;break}a+=o}if(!f)return!0}}return!1}_isKingAttacked(e){return this._attacked(z(e),this._kings[e])}isAttacked(e,t){return this._attacked(t,p[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let i=0,s=0;for(let n=p.a8;n<=p.h1;n++){if(s=(s+1)%2,n&136){n+=7;continue}const l=this._board[n];l&&(e[l.type]=l.type in e?e[l.type]+1:1,l.type===Y&&t.push(s),i++)}if(i===2)return!0;if(i===3&&(e[Y]===1||e[fe]===1))return!0;if(i===e[Y]+2){let n=0;const l=t.length;for(let o=0;o<l;o++)n+=t[o];if(n===0||n===l)return!0}return!1}isThreefoldRepetition(){const e=[],t={};let i=!1;for(;;){const s=this._undoMove();if(!s)break;e.push(s)}for(;;){const s=this.fen().split(" ").slice(0,4).join(" ");t[s]=s in t?t[s]+1:1,t[s]>=3&&(i=!0);const n=e.pop();if(n)this._makeMove(n);else break}return i}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:i=void 0}={}){const s=this._moves({square:t,piece:i});return e?s.map(n=>this._makePretty(n)):s.map(n=>this._moveToSan(n,s))}_moves({legal:e=!0,piece:t=void 0,square:i=void 0}={}){var s;const n=i?i.toLowerCase():void 0,l=t==null?void 0:t.toLowerCase(),o=[],a=this._turn,f=z(a);let d=p.a8,g=p.h1,h=!1;if(n)if(n in p)d=g=p[n],h=!0;else return[];for(let c=d;c<=g;c++){if(c&136){c+=7;continue}if(!this._board[c]||this._board[c].color===f)continue;const{type:m}=this._board[c];let v;if(m===E){if(l&&l!==m)continue;v=c+he[a][0],this._board[v]||(R(o,a,c,v,E),v=c+he[a][1],Zt[a]===K(c)&&!this._board[v]&&R(o,a,c,v,E,void 0,u.BIG_PAWN));for(let k=2;k<4;k++)v=c+he[a][k],!(v&136)&&(((s=this._board[v])===null||s===void 0?void 0:s.color)===f?R(o,a,c,v,E,this._board[v].type,u.CAPTURE):v===this._epSquare&&R(o,a,c,v,E,E,u.EP_CAPTURE))}else{if(l&&l!==m)continue;for(let k=0,$=Ce[m].length;k<$;k++){const _=Ce[m][k];for(v=c;v+=_,!(v&136);){if(!this._board[v])R(o,a,c,v,m);else{if(this._board[v].color===a)break;R(o,a,c,v,m,this._board[v].type,u.CAPTURE);break}if(m===fe||m===P)break}}}}if((l===void 0||l===P)&&(!h||g===this._kings[a])){if(this._castling[a]&u.KSIDE_CASTLE){const c=this._kings[a],m=c+2;!this._board[c+1]&&!this._board[m]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,c+1)&&!this._attacked(f,m)&&R(o,a,this._kings[a],m,P,void 0,u.KSIDE_CASTLE)}if(this._castling[a]&u.QSIDE_CASTLE){const c=this._kings[a],m=c-2;!this._board[c-1]&&!this._board[c-2]&&!this._board[c-3]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,c-1)&&!this._attacked(f,m)&&R(o,a,this._kings[a],m,P,void 0,u.QSIDE_CASTLE)}}if(!e)return o;const b=[];for(let c=0,m=o.length;c<m;c++)this._makeMove(o[c]),this._isKingAttacked(a)||b.push(o[c]),this._undoMove();return b}move(e,{strict:t=!1}={}){let i=null;if(typeof e=="string")i=this._moveFromSan(e,t);else if(typeof e=="object"){const n=this._moves();for(let l=0,o=n.length;l<o;l++)if(e.from===w(n[l].from)&&e.to===w(n[l].to)&&(!("promotion"in n[l])||e.promotion===n[l].promotion)){i=n[l];break}}if(!i)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const s=this._makePretty(i);return this._makeMove(i),s}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,i=z(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&u.EP_CAPTURE&&(this._turn===I?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===P){if(this._kings[t]=e.to,e.flags&u.KSIDE_CASTLE){const s=e.to-1,n=e.to+1;this._board[s]=this._board[n],delete this._board[n]}else if(e.flags&u.QSIDE_CASTLE){const s=e.to+1,n=e.to-2;this._board[s]=this._board[n],delete this._board[n]}this._castling[t]=0}if(this._castling[t]){for(let s=0,n=M[t].length;s<n;s++)if(e.from===M[t][s].square&&this._castling[t]&M[t][s].flag){this._castling[t]^=M[t][s].flag;break}}if(this._castling[i]){for(let s=0,n=M[i].length;s<n;s++)if(e.to===M[i][s].square&&this._castling[i]&M[i][s].flag){this._castling[i]^=M[i][s].flag;break}}e.flags&u.BIG_PAWN?t===I?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=T,e.piece===E?this._halfMoves=0:e.flags&(u.CAPTURE|u.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===I&&this._moveNumber++,this._turn=i}undo(){const e=this._undoMove();return e?this._makePretty(e):null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const i=this._turn,s=z(i);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&u.EP_CAPTURE){let n;i===I?n=t.to-16:n=t.to+16,this._board[n]={type:E,color:s}}else this._board[t.to]={type:t.captured,color:s};if(t.flags&(u.KSIDE_CASTLE|u.QSIDE_CASTLE)){let n,l;t.flags&u.KSIDE_CASTLE?(n=t.to+1,l=t.to-1):(n=t.to-2,l=t.to+1),this._board[n]=this._board[l],delete this._board[l]}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const i=[];let s=!1;for(const h in this._header)i.push("["+h+' "'+this._header[h]+'"]'+e),s=!0;s&&this._history.length&&i.push(e);const n=h=>{const b=this._comments[this.fen()];if(typeof b<"u"){const c=h.length>0?" ":"";h=`${h}${c}{${b}}`}return h},l=[];for(;this._history.length>0;)l.push(this._undoMove());const o=[];let a="";for(l.length===0&&o.push(n(""));l.length>0;){a=n(a);const h=l.pop();if(!h)break;if(!this._history.length&&h.color==="b"){const b=`${this._moveNumber}. ...`;a=a?`${a} ${b}`:b}else h.color==="w"&&(a.length&&o.push(a),a=this._moveNumber+".");a=a+" "+this._moveToSan(h,this._moves({legal:!0})),this._makeMove(h)}if(a.length&&o.push(n(a)),typeof this._header.Result<"u"&&o.push(this._header.Result),t===0)return i.join("")+o.join(" ");const f=function(){return i.length>0&&i[i.length-1]===" "?(i.pop(),!0):!1},d=function(h,b){for(const c of b.split(" "))if(c){if(h+c.length>t){for(;f();)h--;i.push(e),h=0}i.push(c),h+=c.length,i.push(" "),h++}return f()&&h--,h};let g=0;for(let h=0;h<o.length;h++){if(g+o[h].length>t&&o[h].includes("{")){g=d(g,o[h]);continue}g+o[h].length>t&&h!==0?(i[i.length-1]===" "&&i.pop(),i.push(e),g=0):h!==0&&(i.push(" "),g++),i.push(o[h]),g+=o[h].length}return i.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}loadPgn(e,{strict:t=!1,newlineChar:i=`\r?
`}={}){function s(_){return _.replace(/\\/g,"\\")}function n(_){const C={},q=_.split(new RegExp(s(i)));let oe="",be="";for(let W=0;W<q.length;W++){const ke=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;oe=q[W].replace(ke,"$1"),be=q[W].replace(ke,"$2"),oe.trim().length>0&&(C[oe]=be)}return C}e=e.trim();const o=new RegExp("^(\\[((?:"+s(i)+")|.)*\\])((?:\\s*"+s(i)+"){2}|(?:\\s*"+s(i)+")*$)").exec(e),a=o&&o.length>=2?o[1]:"";this.reset();const f=n(a);let d="";for(const _ in f)_.toLowerCase()==="fen"&&(d=f[_]),this.header(_,f[_]);if(!t)d&&this.load(d,!0);else if(f.SetUp==="1"){if(!("FEN"in f))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(f.FEN,!0)}function g(_){return Array.from(_).map(function(C){return C.charCodeAt(0)<128?C.charCodeAt(0).toString(16):encodeURIComponent(C).replace(/%/g,"").toLowerCase()}).join("")}function h(_){return _.length==0?"":decodeURIComponent("%"+(_.match(/.{1,2}/g)||[]).join("%"))}const b=function(_){return _=_.replace(new RegExp(s(i),"g")," "),`{${g(_.slice(1,_.length-1))}}`},c=function(_){if(_.startsWith("{")&&_.endsWith("}"))return h(_.slice(1,_.length-1))};let m=e.replace(a,"").replace(new RegExp(`({[^}]*})+?|;([^${s(i)}]*)`,"g"),function(_,C,q){return C!==void 0?b(C):" "+b(`{${q.slice(1)}}`)}).replace(new RegExp(s(i),"g")," ");const v=/(\([^()]+\))+?/g;for(;v.test(m);)m=m.replace(v,"");m=m.replace(/\d+\.(\.\.)?/g,""),m=m.replace(/\.\.\./g,""),m=m.replace(/\$\d+/g,"");let k=m.trim().split(new RegExp(/\s+/));k=k.filter(_=>_!=="");let $="";for(let _=0;_<k.length;_++){const C=c(k[_]);if(C!==void 0){this._comments[this.fen()]=C;continue}const q=this._moveFromSan(k[_],t);if(q==null)if(Vt.indexOf(k[_])>-1)$=k[_];else throw new Error(`Invalid move in PGN: ${k[_]}`);else $="",this._makeMove(q)}$&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",$)}_moveToSan(e,t){let i="";if(e.flags&u.KSIDE_CASTLE)i="O-O";else if(e.flags&u.QSIDE_CASTLE)i="O-O-O";else{if(e.piece!==E){const s=ei(e,t);i+=e.piece.toUpperCase()+s}e.flags&(u.CAPTURE|u.EP_CAPTURE)&&(e.piece===E&&(i+=w(e.from)[0]),i+="x"),i+=w(e.to),e.promotion&&(i+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(e,t=!1){const i=Ne(e);let s=ye(i),n=this._moves({legal:!0,piece:s});for(let h=0,b=n.length;h<b;h++)if(i===Ne(this._moveToSan(n[h],n)))return n[h];if(t)return null;let l,o,a,f,d,g=!1;o=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(l=o[1],a=o[2],f=o[3],d=o[4],a.length==1&&(g=!0)):(o=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(l=o[1],a=o[2],f=o[3],d=o[4],a.length==1&&(g=!0))),s=ye(i),n=this._moves({legal:!0,piece:l||s});for(let h=0,b=n.length;h<b;h++)if(a&&f){if((!l||l.toLowerCase()==n[h].piece)&&p[a]==n[h].from&&p[f]==n[h].to&&(!d||d.toLowerCase()==n[h].promotion))return n[h];if(g){const c=w(n[h].from);if((!l||l.toLowerCase()==n[h].piece)&&p[f]==n[h].to&&(a==c[0]||a==c[1])&&(!d||d.toLowerCase()==n[h].promotion))return n[h]}}return null}ascii(){let e=`   +------------------------+
`;for(let t=p.a8;t<=p.h1;t++){if(H(t)===0&&(e+=" "+"87654321"[K(t)]+" |"),this._board[t]){const i=this._board[t].type,n=this._board[t].color===y?i.toUpperCase():i.toLowerCase();e+=" "+n+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let i=0;const s=this._turn;for(let n=0,l=t.length;n<l;n++)this._makeMove(t[n]),this._isKingAttacked(s)||(e-1>0?i+=this.perft(e-1):i++),this._undoMove();return i}_makePretty(e){const{color:t,piece:i,from:s,to:n,flags:l,captured:o,promotion:a}=e;let f="";for(const b in u)u[b]&l&&(f+=Ut[b]);const d=w(s),g=w(n),h={color:t,piece:i,from:d,to:g,san:this._moveToSan(e,this._moves({legal:!0})),flags:f,lan:d+g,before:this.fen(),after:""};return this._makeMove(e),h.after=this.fen(),this._undoMove(),o&&(h.captured=o),a&&(h.promotion=a,h.lan+=a),h}turn(){return this._turn}board(){const e=[];let t=[];for(let i=p.a8;i<=p.h1;i++)this._board[i]==null?t.push(null):t.push({square:w(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(e.push(t),t=[],i+=8);return e}squareColor(e){if(e in p){const t=p[e];return(K(t)+H(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],i=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const s=t.pop();if(!s)break;e?i.push(this._makePretty(s)):i.push(this._moveToSan(s,this._moves())),this._makeMove(s)}return i}_pruneComments(){const e=[],t={},i=s=>{s in this._comments&&(t[s]=this._comments[s])};for(;this._history.length>0;)e.push(this._undoMove());for(i(this.fen());;){const s=e.pop();if(!s)break;this._makeMove(s),i(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}}export{ii as C,j as F,U as N,Xe as a,ti as i,$t as l};
