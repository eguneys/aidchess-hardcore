var S=Object.defineProperty;var y=(s,e,t)=>e in s?S(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var i=(s,e,t)=>(y(s,typeof e!="symbol"?e+"":e,t),t);const w=s=>s!==void 0;class b{constructor(){i(this,"engineName");i(this,"work");i(this,"currentEval");i(this,"expectedPvs",1);i(this,"nextWork");i(this,"send");i(this,"options",new Map)}connected(e){this.send=e,this.options=new Map([["Threads","1"],["Hash","16"],["MultiPV","1"],["UCI_Variant","chess"]]),this.send("uci")}setOption(e,t){t=t.toString(),this.send&&this.options.get(e)!==t&&(this.send(`setoption name ${e} value ${t}`),this.options.set(e,t))}disconnected(){this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,this.send=void 0}received(e){var o,p;const t=e.trim().split(/\s+/g);if(t[0]==="uciok")this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true"),(o=this.send)==null||o.call(this,"ucinewgame"),(p=this.send)==null||p.call(this,"isready");else if(t[0]==="readyok")this.swapWork();else if(t[0]==="id"&&t[1]==="name")this.engineName=t.slice(2).join(" ");else if(t[0]==="bestmove"){this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,this.swapWork();return}else if(this.work&&!this.work.stopRequested&&t[0]==="info"){let r=0,n,a=1,c,k,f=!1,u,v=[];for(let h=1;h<t.length;h++)switch(t[h]){case"depth":r=parseInt(t[++h]);break;case"nodes":n=parseInt(t[++h]);break;case"multipv":a=parseInt(t[++h]);break;case"time":c=parseInt(t[++h]);break;case"score":f=t[++h]==="mate",u=parseInt(t[++h]),(t[h+1]==="lowerbound"||t[h+1]==="upperbound")&&(k=t[++h]);break;case"pv":v=t.slice(++h),h=t.length;break}if(f&&!u||(this.expectedPvs<a&&(this.expectedPvs=a),r<6||!w(n)||!w(c)||!w(f)||!w(u)))return;const M=this.work.threatMode?0:1,m=this.work.ply%2===M?-u:u;if(k&&a===1)return;const P={moves:v,cp:f?void 0:m,mate:f?m:void 0,depth:r};a===1?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:r,knps:n/c,nodes:n,cp:f?void 0:m,mate:f?m:void 0,pvs:[P],millis:c}:this.currentEval&&(this.currentEval.pvs.push(P),this.currentEval.depth=Math.min(this.currentEval.depth,r)),a===this.expectedPvs&&this.currentEval&&(this.work.emit(this.currentEval),r>=this.work.maxDepth&&c>8e3&&n>4e3*Math.exp(this.work.maxDepth*.3)&&this.stop())}}stop(){var e;this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,(e=this.send)==null||e.call(this,"stop"))}swapWork(){!this.send||this.work||(this.work=this.nextWork,this.nextWork=void 0,this.work&&(this.currentEval=void 0,this.expectedPvs=1,this.setOption("Threads",this.work.threads),this.setOption("Hash",this.work.hashSize||16),this.setOption("MultiPV",Math.max(1,this.work.multiPv)),this.send(["position fen",this.work.initialFen,"moves",...this.work.moves].join(" ")),this.send(this.work.maxDepth>=99?`go depth ${245}`:"go movetime 90000")))}compute(e){this.nextWork=e,this.stop(),this.swapWork()}isComputing(){return!!this.work&&!this.work.stopRequested}}const E=s=>s,C=s=>new Promise((e,t)=>{let o=document.createElement("script");o.onload=()=>{e(void 0)},o.onerror=p=>{t(p)},o.src=s,document.head.append(o)}),l=class{constructor(e){this.opts=e}getState(){return l.sf.Stockfish?l.failed.Stockfish?4:this.getProtocol().engineName?this.getProtocol().isComputing()?3:2:1:0}getProtocol(){return l.protocols.Stockfish}async boot(){let e="http://"+window.location.host+"/vendor/stockfish-nnue.wasm/";e="https://"+window.location.host+"/vendor/stockfish-nnue.wasm/";const t=e+"stockfish.wasm";let o;o=await new Promise((n,a)=>{fetch(t).then(c=>c.arrayBuffer()).then(c=>n(c))}),await C(e+"stockfish.js");const p=await window.Stockfish({wasmBinary:o,locateFile:n=>E(e+n),wasmMemory:this.opts.wasmMemory}),r=this.getProtocol();return p.addMessageListener(r.received.bind(r)),r.connected(n=>p.postMessage(n)),p}start(e){this.getProtocol().compute(e),l.sf.Stockfish||(l.sf.Stockfish=this.boot().then(()=>{},t=>{console.error(t),l.failed.Stockfish=!0}))}stop(){this.getProtocol().compute(void 0)}destroy(){this.stop()}};let d=l;i(d,"failed",{Stockfish:!1}),i(d,"protocols",{Stockfish:new b}),i(d,"sf",{});const g="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";function O(s){return!!(s.startsWith("O-O")||s.includes("x")||s.toLowerCase()===s)}const x=(s,e)=>{for(;;)try{return new WebAssembly.Memory({shared:!0,initial:s,maximum:e})}catch(t){if(t instanceof RangeError){if(s===e)throw t;e=Math.max(s,Math.floor(e/2))}else throw t}},D=()=>{let s="wasm";I(1,2);const e=1,t=()=>128;return{technology:s,growableSharedMem:!1,supportsNnue:!1,maxThreads:e,maxWasmPages:o=>Math.max(o,32768),maxHashSize:()=>t()}};function I(s,e){if(typeof SharedArrayBuffer!="function")return;const t=x(s,e);if(t.buffer instanceof SharedArrayBuffer){try{window.postMessage(t.buffer,"*")}catch{return}return t}}class q{constructor(e){i(this,"worker");i(this,"platform");i(this,"start",(e,t)=>{this.doStart(e,t)});i(this,"doStart",(e,t)=>{var n;const o=t[t.length-1],p=8,r={threads:1,hashSize:this.hashSize(),stopRequested:!1,initialFen:((n=t[0])==null?void 0:n.fen)||g,moves:[],currentFen:(o==null?void 0:o.fen)||g,path:e,ply:(o==null?void 0:o.ply)||0,maxDepth:p,multiPv:3,threatMode:!1,emit:a=>{this.opts.emit(a,r)}};for(let a=1;a<t.length;a++){const c=t[a];O(c.san)?(r.moves=[],r.initialFen=c.fen):r.moves.push(c.uci)}this.worker||(this.worker=new d({wasmMemory:x(2048,this.platform.maxWasmPages(2048))})),this.worker.start(r)});i(this,"stop",()=>{var e;(e=this.worker)==null||e.stop()});i(this,"hashSize",()=>this.platform.maxHashSize());this.opts=e,this.platform=D()}}export{q as C};
